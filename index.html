<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CNM ‚Ä¢ App v8.6 </title>
  <link rel="icon" href="data:,">
  <style>

*{box-sizing:border-box}
:root{
  --bg:#0b0d12;--panel:#0f1320;--line:#20263a;--text:#eaf0ff;--muted:#95a3bf;
  --chip:#131a2a;--chip-b:#273255;--accent:#4162f2;--accent2:#9b6bff;
}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
.topbar{position:sticky;top:0;z-index:10;display:flex;align-items:center;gap:12px;padding:10px 14px;background:#0f1320;border-bottom:1px solid var(--line)}
.brand{display:flex;gap:8px;align-items:center;font-weight:900;letter-spacing:.6px}
.brandLogo{width:26px;height:26px;border-radius:6px}
.tabs{display:flex;gap:6px;flex-wrap:wrap}
.tab{background:var(--chip);color:#cbd5e1;border:1px solid var(--chip-b);padding:8px 10px;border-radius:10px;cursor:pointer}
.tab.active, .tab:hover{background:#1b2439;color:#fff}
.tab.locked{opacity:.4;cursor:not-allowed}
.spacer{flex:1}
main{max-width:1220px;margin:24px auto;padding:0 12px}
.panel{background:var(--panel);border:1px solid #212a44;border-radius:18px;padding:16px;margin-bottom:14px;box-shadow:0 10px 30px rgba(0,0,0,.28)}
h1,h2,h3{margin:0 0 8px 0}h2{font-size:16px}h3{font-size:14px;color:#e8ecff}
.input{background:#0b1020;border:1px solid #24304c;color:#e2e8f0;border-radius:10px;padding:10px 12px;width:100%}
.input.small{padding:6px 8px;font-size:14px}
.row{display:flex;gap:10px;align-items:center}
.grid{display:grid;gap:12px}.g2{grid-template-columns:repeat(2,1fr)}.g3{grid-template-columns:repeat(3,1fr)}.g5{grid-template-columns:repeat(5,1fr)}
.btn{background:#192444;border:1px solid #2a3860;color:#e2e8f0;border-radius:10px;padding:10px 12px;cursor:pointer}
.btn.primary{background:#2952e3;border-color:var(--accent)}.btn.tiny{padding:4px 8px;font-size:12px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid #1d2540;padding:10px;text-align:left;font-size:14px}
.tiny{font-size:12px}.muted{color:var(--muted)}
.badge{display:inline-flex;gap:6px;align-items:center;background:#0c1428;border:1px solid #1b2b54;border-radius:999px;padding:4px 8px;font-size:12px}
.chip{display:inline-flex;gap:6px;align-items:center;background:var(--chip);border:1px solid var(--chip-b);border-radius:999px;padding:4px 8px;color:#d6e2ff;font-weight:600;user-select:none;cursor:pointer;font-size:12px}
.chip.active{outline:1px solid #4b7bff; box-shadow:0 0 0 3px rgba(75,123,255,.15)}
.color{width:12px;height:12px;border-radius:4px;border:1px solid #24304c}
.legend{display:flex;gap:10px;flex-wrap:wrap}
.caption{font-size:12px;color:#93a2bf;margin-top:6px;text-align:left}
canvas{background:#0b1020;border:1px solid #1a2340;border-radius:12px;padding:6px}
canvas.donut{max-height:150px}
/* KPI */
.kpisLine{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
.kpiZone{background:linear-gradient(135deg,#062a14 0%, #052314 100%);border:1px solid #14442d;border-radius:14px;padding:6px;color:#b7ffda;min-width:92px;width:100%}
.kpiZone .name{font-size:10px;font-weight:700}.kpiZone .val{font-size:12px;font-weight:800}.kpiZone .meta{font-size:9px;margin-top:4px;color:#9be0c9}
/* TID */
.tidLegend{display:flex;gap:10px;margin-top:8px;flex-wrap:wrap}
.tidPill{display:inline-flex;gap:8px;align-items:center;border-radius:999px;padding:6px 10px;font-weight:700}
.tidLow{background:rgba(16,185,129,.12);border:1px solid rgba(16,185,129,.3);color:#6ef2c3}
.tidMid{background:rgba(245,158,11,.12);border:1px solid rgba(245,158,11,.3);color:#ffd698}
.tidHigh{background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.3);color:#ff9f9f}
.tidType{display:inline-flex;gap:8px;align-items:center;border-radius:999px;padding:6px 10px;font-weight:800;border:1px solid}
.tidType.pol{background:rgba(99,102,241,.12);border-color:rgba(99,102,241,.35);color:#c7c9ff}
.tidType.pyr{background:rgba(59,130,246,.12);border-color:rgba(59,130,246,.35);color:#c5dcff}
.tidType.thr{background:rgba(245,158,11,.12);border-color:rgba(245,158,11,.35);color:#ffd698}
.tidType.mix{background:rgba(148,163,184,.12);border-color:rgba(148,163,184,.35);color:#d7dee7}
/* Lock */
.lockWrap{min-height:76vh;display:grid;place-items:center;padding:24px}
.lockCard{width:100%;max-width:540px;background:linear-gradient(180deg,#0f1428 0%, #0b1020 100%);border:1px solid #1b2b54;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.45);padding:26px}
.lockBrand{display:flex;align-items:center;gap:12px;margin-bottom:6px}
.lockLogoImg{width:42px;height:42px;border-radius:10px;box-shadow:0 10px 30px rgba(53,80,255,.35)}
.lockTitle{font-size:20px;font-weight:900;letter-spacing:.3px}
.lockSubTitle{color:#9ab1ff;margin-top:2px}
/* Planning */
.planRow{display:grid;grid-template-columns:90px 1fr 1fr;gap:10px;margin-bottom:8px}
.dayPill{display:inline-flex;align-items:center;justify-content:center;width:42px;height:26px;border-radius:999px;background:#141c2f;border:1px solid #26314b;font-weight:800;color:#d7e3ff}
/* volume side note */
.volumeSideNote{position:absolute;right:14px;top:10px;color:#9aa6c0;font-size:12px}
@media (max-width: 900px){ .kpisLine{grid-template-columns:repeat(3,1fr)} }


/* === HRV KPIs === */
.hrvRow{display:grid;grid-template-columns:150px 1fr;gap:12px;align-items:center;margin:8px 0}
.hrvHead{display:flex;align-items:center;gap:8px;font-weight:900;color:#eaf0ff}
.hrvStatWrap{display:grid;grid-template-columns:repeat(7,minmax(120px,1fr));gap:10px}
.hrvStat{background:var(--chip);border:1px solid var(--chip-b);border-radius:12px;padding:8px 10px}
.hrvStat .label{font-size:11px;color:var(--muted);margin-bottom:2px;display:flex;align-items:center;gap:6px}
.hrvStat .value{font-size:14px;font-weight:800;color:#eaf2ff;line-height:1.2}
.hrvStat .delta{font-size:11px;font-weight:700}
.delta.up{color:#34d399}.delta.down{color:#f87171}.delta.flat{color:#a3b0c9}
.tinyTime{font-size:11px;color:#95a3bf}
</style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <img src="data:image/svg+xml;base64," class="brandLogo" alt="CNM">
      <span>CNM</span>
    </div>
    <nav class="tabs">
      <button class="tab" data-tab="home">Accueil</button>
      <button class="tab" data-tab="dashboard">Dashboard</button>
      <button class="tab" data-tab="athletes">Athl√®tes</button>
      <button class="tab" data-tab="sessions">S√©ances</button>
      <button class="tab" data-tab="hrv">HRV</button>
      <button class="tab" data-tab="poids">Poids</button>
      <button class="tab" data-tab="tests">Tests</button>
      <button class="tab" data-tab="competitions">Comp√©titions</button>
      <button class="tab" data-tab="planning">Planification</button>
    </nav>
    <div class="spacer"></div>
    <select id="athFilter" class="input small"></select>
  </header>
  <main id="app">
    <section id="view"></section>
  </main>
  <script>

// ====== CONFIG ======
const SUPABASE_URL = "https://loiukywplbubyghbrexz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxvaXVreXdwbGJ1YnlnaGJyZXh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMjEzNDYsImV4cCI6MjA3MTY5NzM0Nn0.gDqfiTlNyGCztFQDjALlSUgF6BvJxGrnHnH9zICmAqQ";
if (!window.supabase || !window.supabase.createClient) { alert("Supabase non charg√© (CDN). L'application s'ouvre mais les donn√©es ne seront pas en ligne."); }
const supa = window.supabase && window.supabase.createClient ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : { from: ()=>({ select:async()=>({data:[],error:null}), insert:async()=>({error:null}), upsert:async()=>({error:null}), update:async()=>({error:null}), delete:async()=>({error:null}), order:()=>({}), eq:()=>({}), }) };
try{ Chart.register(ChartDataLabels); }catch(e){}

// ====== LOCK ======
const ACCESS_CODE = "cnm";
const normalizeCode = s => (s||'').toString().trim().replace(/\s+/g,'').toUpperCase();
const isUnlocked = () => localStorage.getItem('cnm_unlocked')==='1';
const setUnlocked = v => v ? localStorage.setItem('cnm_unlocked','1') : localStorage.removeItem('cnm_unlocked');
(function(){ try{ const u=new URLSearchParams(location.search).get('unlock'); if(u && normalizeCode(u)===normalizeCode(ACCESS_CODE)) setUnlocked(true); }catch(e){} })();

// ====== STATE ======
const state = { athletes: [], sessions: [], hrv: [], weight: [], competitions: [], planning_seasons: [], planning_weeks: [], planning_items: [] };
let selectedAthleteId = "ALL";
let weekGlobal = getWeekString(new Date());
let weeksA = [getWeekString(new Date())];
let weeksB = [getWeekString(new Date())];
const charts = {}; let activeZone = null;

// Quantif
const elView = document.getElementById('view');
const $ = (id) => document.getElementById(id);
const toISO = (d) => { const dt = (d instanceof Date) ? d : new Date(d); return isNaN(dt) ? null : dt.toISOString().slice(0,10); };
const fmt = (n) => (Math.round((+n||0)*100)/100).toFixed(2);
const ZONES = [
  {key:'vert',   name:'Vert',   color:'#16a34a'},
  {key:'bleu',   name:'Bleu',   color:'#2563eb'},
  {key:'orange', name:'Orange', color:'#f59e0b'},
  {key:'rouge',  name:'Rouge',  color:'#ef4444'},
  {key:'violet', name:'Violet', color:'#8b5cf6'}
];
function sumSessionZones(s){ return (+s.zone_vert||0)+(+s.zone_bleu||0)+(+s.zone_orange||0)+(+s.zone_rouge||0)+(+s.zone_violet||0); }
function getWeekString(date){ const d=new Date(Date.UTC(date.getFullYear(),date.getMonth(),date.getDate()));const dayNum=d.getUTCDay()||7;d.setUTCDate(d.getUTCDate()+4-dayNum);const yStart=new Date(Date.UTC(d.getUTCFullYear(),0,1));const week=Math.ceil((((d-yStart)/86400000)+1)/7);return `${d.getUTCFullYear()}-W${String(week).padStart(2,'0')}`; }
function weekRange(weekStr){ const parts = (weekStr||'').split('-W'); const year=+parts[0]; const w=+parts[1]; const simple=new Date(Date.UTC(year,0,1+(w-1)*7)); const dow=simple.getUTCDay(); const start=new Date(simple); if(dow<=4) start.setUTCDate(simple.getUTCDate()-simple.getUTCDay()+1); else start.setUTCDate(simple.getUTCDate()+8-simple.getUTCDay()); const end=new Date(start); end.setUTCDate(end.getUTCDate()+6); return {start:toISO(start), end:toISO(end)};}
function shiftWeek(weekStr, delta){ const {start}=weekRange(weekStr); const d=new Date(start); d.setDate(d.getDate()+delta*7); return getWeekString(d); }
function inRange(d, start, end){ return d >= start && d <= end; }
function destroyChart(id){ if (charts[id]) { charts[id].destroy(); charts[id]=null; } }
function listWeeks(n=50){ const out=[]; let w=getWeekString(new Date()); for(let i=0;i<n;i++){ out.push(w); w=shiftWeek(w,-1); } return out; }
function weeksWithData(max=50){
  const map = new Map();
  for(const s of state.sessions){
    if (selectedAthleteId!=='ALL' && !(s.attendees||[]).includes(selectedAthleteId)) continue;
    const wk = getWeekString(new Date(s.date));
    map.set(wk, (map.get(wk)||0) + sumSessionZones(s));
  }
  const arr = Array.from(map.entries()).filter(x=>x[1]>0).map(x=>x[0]).sort().reverse();
  return arr.slice(0, max);
}
function sessionsOfWeek(weekStr){
  const rng = weekRange(weekStr); const start=rng.start, end=rng.end;
  const base = state.sessions.filter(s => inRange(s.date,start,end));
  if (selectedAthleteId==='ALL') return base;
  return base.filter(s => (s.attendees||[]).includes(selectedAthleteId));
}
function sessionsOfWeeks(weeks){
  const set = new Set(weeks||[]);
  return state.sessions.filter(s=>{
    const wk = getWeekString(new Date(s.date));
    if(!set.has(wk)) return false;
    if (selectedAthleteId!=='ALL' && !(s.attendees||[]).includes(selectedAthleteId)) return false;
    return true;
  });
}
function toPercentZones(sessions){
  const sums = {vert:0,bleu:0,orange:0,rouge:0,violet:0};
  sessions.forEach(s => { sums.vert+=(+s.zone_vert||0); sums.bleu+=(+s.zone_bleu||0); sums.orange+=(+s.zone_orange||0); sums.rouge+=(+s.zone_rouge||0); sums.violet+=(+s.zone_violet||0); });
  const total = Object.values(sums).reduce((a,b)=>a+b,0) || 1;
  const pct = {}; for(const k in sums){ pct[k] = +(100*sums[k]/total).toFixed(1); }
  return { sums, pct, total };
}
function computeTID(z){ const low=(z.vert||0)+(z.bleu||0), mid=(z.orange||0), high=(z.rouge||0)+(z.violet||0);
  if (mid >= low*1.05 && mid >= high*1.05) return {label:'Threshold',low,mid,high};
  if (low >= mid && mid >= high) return {label:'Pyramidal',low,mid,high};
  if (low >= 70 && high > mid) return {label:'Polaris√©',low,mid,high};
  return {label:'Mixte',low,mid,high};
}
function groupWeeklyVolumesFiltered(max=50){
  const map = new Map();
  for (const s of state.sessions){
    if (selectedAthleteId!=='ALL' && !(s.attendees||[]).includes(selectedAthleteId)) continue;
    const wk = getWeekString(new Date(s.date));
    map.set(wk, (map.get(wk)||0) + sumSessionZones(s));
  }
  const entries = Array.from(map.entries()).filter(e=>e[1]>0).sort((a,b)=> a[0]<b[0]? -1:1).slice(-max);
  return { labels: entries.map(e=>e[0]), data: entries.map(e=> +(e[1].toFixed(2))) };
}

// NAV
function mountTabs(){
  const tabs = document.querySelectorAll('.tab');
  const lockOther = !isUnlocked();
  tabs.forEach(t => {
    const tab = t.getAttribute('data-tab');
    if (lockOther && tab!=='home') t.classList.add('locked'); else t.classList.remove('locked');
    t.onclick = () => {
      if (!isUnlocked() && tab!=='home'){ renderHome(true); return; }
      tabs.forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      if (tab==='home') renderHome();
      if (tab==='dashboard') renderDashboard();
      if (tab==='athletes') renderAthletes();
      if (tab==='sessions') renderSessions();
      if (tab==='hrv') renderHRV();
      if (tab==='poids') renderWeight();
      if (tab==='competitions') renderCompetitions();
            if (tab==='tests') renderTesting();
if (tab==='planning') renderPlanning();
    };
  });
  if (tabs[0]) { tabs[0].click(); }
}

// HOME
function renderHome(){
  if (!isUnlocked()){
    elView.innerHTML = `
      <div class="lockWrap">
        <div class="lockCard">
          <div class="lockBrand">
            <img src="data:image/svg+xml;base64," alt="Cercle des Nageurs de Marseille" class="lockLogoImg"/>
            <div>
              <div class="lockTitle">CNM ‚Äî Espace s√©curis√©</div>
              <div class="lockSubTitle tiny">Cellule d‚Äôoptimisation de la performance sportive du CN Marseille</div>
            </div>
          </div>
          <div class="row">
            <input id="pin" class="input" type="password" placeholder="Code d‚Äôacc√®s" autocomplete="one-time-code"/>
            <button id="btnUnlock" class="btn primary">Entrer</button>
          </div>
        </div>
      </div>`;
    const btn=$('btnUnlock'), pin=$('pin');
    const go=()=>{ const ok = normalizeCode(pin.value)===normalizeCode(ACCESS_CODE); if(ok){ setUnlocked(true); mountTabs(); renderHome(); } else alert('Code incorrect.'); };
    btn.onclick=go; pin.onkeydown=(e)=>{ if(e.key==='Enter') go(); };
    return;
  }
  elView.innerHTML = `
    <div class="panel">
      <div class="row" style="align-items:center;gap:10px;margin-bottom:6px">
        <img src="data:image/svg+xml;base64," alt="Cercle des Nageurs de Marseille" class="lockLogoImg"/>
        <div>
          <div class="lockTitle">CNM ‚Äî Accueil</div>
          <div class="lockSubTitle tiny">Cellule d‚Äôoptimisation de la performance sportive du CN Marseille</div>
        </div>
      </div>
      <button class="btn tiny" id="btnRelock">Verrouiller</button>
    </div>`;
  $('btnRelock').onclick = ()=>{ setUnlocked(false); mountTabs(); renderHome(true); };
}

// Filtrer 
function mountAthleteFilter(){
  const sel = $('athFilter'); if(!sel) return;
  const prev = sel.value;
  sel.innerHTML = '<option value="ALL">Vue: Tous</option>' + (state.athletes||[]).map(a=>`<option value="${a.id}">Vue: ${a.name}</option>`).join('');
  sel.value = (prev && [...sel.options].some(o=>o.value===prev)) ? prev : 'ALL';
  selectedAthleteId = sel.value;
  sel.onchange = (e)=>{ selectedAthleteId = e.target.value; const n = document.querySelector('.tab.active'); const active = n ? n.dataset.tab : null; if (active==='dashboard') renderDashboard(); };
}

// SYNC 
async function refreshTests(){
  if (!supa) { /* local only */ return; }
  try {
    const resT = await supa.from('tests').select('*').order('date', {ascending: true});
    state.tests = (resT && resT.data) || (state.tests||[]);
  } catch(e){ state.tests = state.tests || []; }
}

async function syncAll(){
  try{ const resA = await supa.from('athletes').select('*').order('created_at',{ascending:true}); state.athletes = (resA&&resA.data)||[]; }catch(e){ state.athletes=[]; }
  try{ const resS = await supa.from('sessions').select('*').order('date',{ascending:false}); state.sessions = (resS&&resS.data)||[]; }catch(e){ state.sessions=[]; }
  try{ const resH = await supa.from('hrv').select('*').order('date',{ascending:false}); state.hrv = (resH&&resH.data)||[]; }catch(e){ state.hrv=[]; }
  try{ const resW = await supa.from('weight').select('*').order('date',{ascending:false}); state.weight = (resW&&resW.data)||[]; }catch(e){ state.weight=[]; }
  try{ const resC = await supa.from('competitions').select('*').order('date',{ascending:false}); state.competitions = (resC&&resC.data)||[]; }catch(e){ state.competitions=[]; }
  try{ const resPS = await supa.from('planning_seasons').select('*').order('start_date',{ascending:false}); state.planning_seasons = (resPS&&resPS.data)||[]; }catch(e){ state.planning_seasons=[]; }
  try{ const resPW = await supa.from('planning_weeks').select('*').order('week',{ascending:false}); state.planning_weeks = (resPW&&resPW.data)||[]; }catch(e){ state.planning_weeks=[]; }
  try{ const resPI = await supa.from('planning_items').select('*').order('sort',{ascending:true}); state.planning_items = (resPI&&resPI.data)||[]; }catch(e){ state.planning_items=[]; }
  mountAthleteFilter();
}

// DASHBOARD 
function renderDashboard(){
  if (!isUnlocked()) return renderHome(true);
  const weekList = weeksWithData(50);
  if (weekList.length && weekList.indexOf(weekGlobal)===-1) weekGlobal = weekList[0];

  var foundA = state.athletes.find(function(a){return a.id===selectedAthleteId;});
  var who = (selectedAthleteId==='ALL') ? 'Tous' : (foundA ? foundA.name : 'Athl√®te');
  const curr = sessionsOfWeek(weekGlobal);
  const prev = sessionsOfWeek(shiftWeek(weekGlobal,-1));
  const P = toPercentZones(curr), Pprev = toPercentZones(prev);
  const tid = computeTID(P.pct);

  const weekRec = (state.planning_weeks||[]).find(function(x){return x.week===weekGlobal;});
  const microRows = (state.planning_items||[]).filter(function(x){return x.week===weekGlobal;}).sort(function(a,b){ return (a.sort||0)-(b.sort||0); });
  var seasonName=''; if (weekRec){ var season = (state.planning_seasons||[]).find(function(s){return s.id===weekRec.season_id;}); seasonName = season ? season.name : ''; }

  elView.innerHTML = `
    <div class="panel">
      <div class="row" style="gap:12px;flex-wrap:wrap">
        <div class="badge"><strong>Vue:</strong>&nbsp;<span>${who}</span></div>
        <div class="badge">Semaine 
          <select class="input small" id="weekGlobalSel" style="width:160px;margin-left:8px">
            ${weekList.length? weekList.map(w=>`<option value="${w}" ${w===weekGlobal?'selected':''}>${w}</option>`).join('') : `<option>${weekGlobal}</option>`}
          </select>
        </div>
        <button class="btn tiny" id="wgPrev">‚óÄÔ∏é</button><button class="btn tiny" id="wgNext">‚ñ∂Ô∏é</button>
      </div>
    </div>

    <div class="panel">
      <h2>Th√®me & microcycle</h2>
      <div class="tiny muted" style="margin:6px 0">Semaine ${weekGlobal}${seasonName? ' ‚Ä¢ Saison '+seasonName:''}</div>
      <div style="margin:6px 0 12px; font-weight:800">${weekRec && weekRec.theme ? weekRec.theme : '<span class="muted">‚Äî</span>'}</div>
      <table class="table"><thead><tr><th>Jour</th><th>Focus</th><th>D√©tails</th></tr></thead><tbody id="tblMicroRO">${microRows.length? microRows.map(r=>`<tr><td><span class="dayPill">${r.day_label||''}</span></td><td>${r.focus||''}</td><td>${r.details||''}</td></tr>`).join('') : '<tr><td colspan="3" class="muted">‚Äî</td></tr>'}</tbody></table>
    </div>

    <div class="panel">
      <h2>TID & KPIs</h2>
      <div class="grid g2">
        <div>
          <div class="legend" style="margin:8px 0 6px">
            ${ZONES.map(z => `<span class="chip" data-zone="${z.key}"><span class="color" style="background:${z.color}"></span>${z.name}</span>`).join('')}
          </div>
          <div class="row" style="justify-content:center;margin-top:4px"><canvas id="chartZonesGlobal" class="donut"></canvas></div>
          <div class="caption">T.I.D : (Vert+Bleu) / (Orange) / (Rouge+Violet)</div>
          <div class="tidLegend">
            <span class="tidPill tidLow">Bas ${(tid.low).toFixed(0)}%</span>
            <span class="tidPill tidMid">Mod√©r√© ${(tid.mid).toFixed(0)}%</span>
            <span class="tidPill tidHigh">√âlev√© ${(tid.high).toFixed(0)}%</span>
          </div>
          <div id="tidTypeWrap" style="margin-top:6px"></div>
        </div>
        <div>
          <h3 style="margin-bottom:6px">Variation S-1 (par zone)</h3>
          <div class="kpisLine" id="zoneVar"></div>
          <div class="tiny muted" style="margin-top:6px">Semaine actuelle: ${weekGlobal} / Pr√©c√©dente: ${shiftWeek(weekGlobal,-1)}</div>
        </div>
      </div>
    </div>

    <div class="panel" style="position:relative">
      <div class="grid g2">
        <div>
          <h2>Volume hebdo (jusqu'√† 50, non nuls)</h2>
          <span class="volumeSideNote tiny">Somme de toutes les zones</span>
          <canvas id="chartVolume50" height="80"></canvas>
        </div>
        <div>
          <h2>Tests</h2>
          <div class="row" style="gap:8px;align-items:center">
            <div class="tiny muted">Type</div>
            <select id="testTypeSel" class="input small">
              <option value="CSS" selected>Vitesse critique (CSS)</option>
            </select>
          </div>
          <div id="testKPI" class="kpisLine" style="margin-top:8px"></div>
          <div class="tiny muted" id="testDeltaNote" style="margin-top:6px"></div>
        </div>
      </div>
    </div>

    <div class="panel">
      <h2>Comparateur A vs B (s√©lection multi-semaines)</h2>
      <div class="row" style="gap:12px;flex-wrap:wrap">
        <div class="badge">Semaines A
          <select id="cmpA" class="input" multiple size="8" style="min-width:180px; margin-left:8px">
            ${listWeeks(50).map(w=>`<option value="${w}" ${weeksA.includes(w)?'selected':''}>${w}</option>`).join('')}
          </select>
        </div>
        <div class="badge">Semaines B
          <select id="cmpB" class="input" multiple size="8" style="min-width:180px; margin-left:8px">
            ${listWeeks(50).map(w=>`<option value="${w}" ${weeksB.includes(w)?'selected':''}>${w}</option>`).join('')}
          </select>
        </div>
        <div class="kpiDelta" id="cmpVolDelta">Volume Œî: ‚Äî</div>
      </div>
      <div class="grid g2" style="margin-top:10px">
        <div><h3>R√©partition par zone ‚Äî A vs B</h3><canvas id="cmpZones" height="140"></canvas></div>
        <div><h3>Volume A vs B</h3><canvas id="cmpVol" height="140"></canvas></div>
      </div>
      <div style="margin-top:10px">
        <h3>√âvolution B vs A (zones)</h3>
        <table class="table"><thead><tr><th>Zone</th><th>A (%)</th><th>B (%)</th><th>Œî pts</th><th>Œî % relatif</th></tr></thead><tbody id="tblDelta"></tbody></table>
      </div>
    </div>
  `;

  // week dropdown
  $('weekGlobalSel').onchange = (e)=>{ weekGlobal = e.target.value || weekGlobal; renderDashboard(); };
  $('wgPrev').onclick = ()=>{ weekGlobal = shiftWeek(weekGlobal,-1); renderDashboard(); };
  $('wgNext').onclick = ()=>{ weekGlobal = shiftWeek(weekGlobal, 1); renderDashboard(); };

  // donut
  const donutOpts = { cutout:'55%', plugins:{ legend:{display:false}, datalabels:{ formatter:(v)=> v? (v+'%'):'', clamp:true, anchor:'center', align:'center', font:{size:9,weight:'700'}, color:'#fff' } } };
  destroyChart('zonesGlobal');
  charts.zonesGlobal = new Chart($('chartZonesGlobal').getContext('2d'), {
    type: 'doughnut',
    data: { labels: ZONES.map(z=>z.name), datasets: [{ data: ZONES.map(z=>P.pct[z.key]), backgroundColor: ZONES.map(z=>z.color), borderWidth:0 }] },
    options: donutOpts
  });
  (function(){ const wrap = $('tidTypeWrap'); if(!wrap) return; const cls = (tid.label==='Polaris√©') ? 'pol' : (tid.label==='Pyramidal' ? 'pyr' : (tid.label==='Threshold' ? 'thr' : 'mix')); wrap.innerHTML = `<span class="tidType ${cls}">Type TID : ${tid.label}</span>`; })();
  (function(){ document.querySelectorAll('.legend .chip').forEach(ch=>{ ch.onclick = () => { const k = ch.getAttribute('data-zone'); activeZone = (activeZone === k) ? null : k; document.querySelectorAll('.legend .chip').forEach(x=>x.classList.toggle('active', x===ch && activeZone)); const base = ZONES.map(z=>z.color); const dim = ZONES.map(z=> z.key===activeZone || !activeZone ? z.color : (z.color+'33')); charts.zonesGlobal.data.datasets[0].backgroundColor = activeZone ? dim : base; charts.zonesGlobal.update(); }; }); })();

  // KPI S-1
  const varHost = $('zoneVar'); varHost.innerHTML = '';
  ['vert','bleu','orange','rouge','violet'].forEach(k => {
    const s = (P.sums[k]||0), sp = (Pprev.sums[k]||0);
    const pctChange = sp>0 ? Math.round(100*(s-sp)/sp) : (s>0 ? 100 : 0);
    const box = document.createElement('div'); box.className = 'kpiZone';
    const zname = ZONES.find(z=>z.key===k).name;
    box.innerHTML = `<div class="name">${zname}</div><div class="val">‚ñ≤ ${pctChange}%</div><div class="meta">S: ${fmt(s)} ¬∑ S-1: ${fmt(sp)}</div>`;
    varHost.appendChild(box);
  });

  // Weekly volume 
  destroyChart('vol50');
  const wk = groupWeeklyVolumesFiltered(50);
  charts.vol50 = new Chart($('chartVolume50').getContext('2d'), {
    type: 'bar',
    data: { labels: wk.labels, datasets: [{ data: wk.data, borderRadius: 6, backgroundColor: '#4162f2' }] },
    options: { plugins:{ legend:{display:false} }, scales:{ x:{ grid:{display:false}, ticks:{color:'#9db0d6', maxRotation:0, minRotation:0} }, y:{ grid:{color:'#1d2740'}, ticks:{color:'#9db0d6'} } } }
  });

  
  // Comparator
  function AorB(weeks){ const A = sessionsOfWeeks(weeks); return toPercentZones(A); }
  const SA = AorB(weeksA), SB = AorB(weeksB);
  const dAbs = +(SB.total - SA.total).toFixed(2);
  const dPct = SA.total ? +((100*(SB.total-SA.total)/SA.total).toFixed(1)) : (SB.total>0 ? 100 : 0);
  $('cmpVolDelta').innerText = `Volume Œî: ${dAbs>=0?'+':''}${fmt(dAbs)}  (${dPct>=0?'+':''}${dPct}%)`;
  destroyChart('cmpZones');
  charts.cmpZones = new Chart($('cmpZones').getContext('2d'), {
    type:'bar',
    data:{
      labels: ZONES.map(z=>z.name),
      datasets:[
        { label:'A', data: ZONES.map(z=>SA.pct[z.key]), backgroundColor:'#4b7bff', borderRadius:8 },
        { label:'B', data: ZONES.map(z=>SB.pct[z.key]), backgroundColor:'#9b6bff', borderRadius:8 }
      ]
    },
    options:{
      plugins:{ legend:{ labels:{ color:'#cfe0ff' } } },
      scales:{ x:{ grid:{display:false}, ticks:{color:'#9db0d6'} },
               y:{ grid:{color:'#1d2740'}, ticks:{color:'#9db0d6'} } }
    }
  });
  destroyChart('cmpVol');
  charts.cmpVol = new Chart($('cmpVol').getContext('2d'), {
    type:'bar',
    data:{ labels:['A','B'], datasets:[{ data:[SA.total, SB.total], backgroundColor:'#4162f2', borderRadius:10 }] },
    options:{ plugins:{ legend:{display:false} },
              scales:{ x:{grid:{display:false}, ticks:{color:'#9db0d6'}},
                       y:{grid:{color:'#1d2740'}, ticks:{color:'#9db0d6'}} } }
  });
  const deltaHost = $('tblDelta');
  deltaHost.innerHTML = ['vert','bleu','orange','rouge','violet'].map(k=>{
    const zobj = ZONES.find(z=>z.key===k);
    const name = zobj ? zobj.name : k;
    const a = SA.pct[k]||0, b = SB.pct[k]||0;
    const dPts = +(b-a).toFixed(1);
    const dRel = a>0 ? +(((b-a)/a*100).toFixed(1)) : (b>0 ? 100 : 0);
    const signPts = dPts>=0?'+':''; const signRel = dRel>=0?'+':'';
    return `<tr><td>${name}</td><td>${a.toFixed(1)}%</td><td>${b.toFixed(1)}%</td><td>${signPts}${dPts} pts</td><td>${signRel}${dRel}%</td></tr>`;
  }).join('');
  $('cmpA').onchange = (e)=>{ const sel=[...e.target.selectedOptions].map(o=>o.value); if(sel.length) weeksA=sel; renderDashboard(); };
  $('cmpB').onchange = (e)=>{ const sel=[...e.target.selectedOptions].map(o=>o.value); if(sel.length) weeksB=sel; renderDashboard(); };
}

// ATHLETES 
function renderAthletes(){
  if (!isUnlocked()) return renderHome(true);
  elView.innerHTML = `
    <div class="panel">
      <h2>Ajouter un athl√®te</h2>
      <div class="grid g3" style="margin-top:8px">
        <div><div class="tiny muted">Nom</div><input class="input" id="a_name"/></div>
        <div><div class="tiny muted">Groupe</div><input class="input" id="a_group"/></div>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:8px"><button class="btn primary" id="btnAddAthlete">Ajouter</button></div>
    </div>
    <div class="panel" style="margin-top:10px">
      <h2>Liste des athl√®tes</h2>
      <table class="table"><thead><tr><th>Nom</th><th>Groupe</th><th></th></tr></thead><tbody id="tblAth"></tbody></table>
    </div>`;
  $('btnAddAthlete').onclick = async ()=>{
    const name = $('a_name').value.trim(); if(!name) return alert('Nom requis');
    const groupe = $('a_group').value.trim();
    const res = await supa.from('athletes').insert({ name, groupe });
    if (res && res.error) return alert('Erreur: '+res.error.message);
    await syncAll(); renderAthletes();
  };
  const tb = $('tblAth');
  tb.innerHTML = (state.athletes||[]).map(a=>`<tr><td>${a.name||''}</td><td>${a.groupe||''}</td><td><button class="btn tiny" data-del="${a.id}">Suppr.</button></td></tr>`).join('');
  tb.querySelectorAll('[data-del]').forEach(b=>{
    b.onclick = async ()=>{ const res = await supa.from('athletes').delete().eq('id', b.getAttribute('data-del')); if(res && res.error) return alert('Erreur: '+res.error.message); await syncAll(); renderAthletes(); };
  });
}

// SESSIONS
function renderSessions(){
  if (!isUnlocked()) return renderHome(true);
  const opts = (state.athletes||[]).map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
  elView.innerHTML = `
    <div class="panel">
      <h2>Nouvelle s√©ance</h2>
      <div class="grid g3" style="margin-top:8px">
        <div>
          <div class="tiny muted">Date</div>
          <input class="input" id="s_date" type="date"/>
          <div class="tiny muted" style="margin-top:8px">AM / PM</div>
          <select id="s_ampm" class="input">
            <option value="AM">AM (matin)</option>
            <option value="PM">PM (apr√®s-midi)</option>
          </select>
        </div>
        <div>
          <div class="tiny muted">Participants</div>
          <select id="s_att" class="input" multiple size="6">${opts}</select>
        </div>
        <div>
          <div class="tiny muted">Distance par zone (m)</div>
          <div class="grid g3">
            <input class="input" id="z_vert" placeholder="Vert (m)"/><input class="input" id="z_bleu" placeholder="Bleu (m)"/><input class="input" id="z_orange" placeholder="Orange (m)"/>
            <input class="input" id="z_rouge" placeholder="Rouge (m)"/><input class="input" id="z_violet" placeholder="Violet (m)"/><input class="input" id="z_note" placeholder="Note (optionnel)"/>
          </div>
          <div class="tiny muted" id="s_total_hint" style="margin-top:6px">Total: 0 m</div>
        </div>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:8px"><button class="btn primary" id="btnAddSession">Enregistrer</button></div>
    </div>
    <div class="panel">
      <h2>Derni√®res s√©ances</h2>
      <table class="table"><thead><tr><th>Date</th><th>AM/PM</th><th>Participants</th><th>Total (m)</th><th>Note</th><th></th></tr></thead><tbody id="tblSess"></tbody></table>
    </div>`;

  function toN(v){ return +v||0; }
  function refreshTotal(){
    const t = toN($('z_vert').value)+toN($('z_bleu').value)+toN($('z_orange').value)+toN($('z_rouge').value)+toN($('z_violet').value);
    $('s_total_hint').textContent = 'Total: ' + t + ' m';
  }
  ['z_vert','z_bleu','z_orange','z_rouge','z_violet'].forEach(id=>{ const el=$(id); if(el){ el.addEventListener('input', refreshTotal); }});
  refreshTotal();

  $('btnAddSession').onclick = async ()=>{
    const date = $('s_date').value || toISO(new Date());
    const ampm = $('s_ampm').value || 'AM';
    const attendees = [...$('s_att').selectedOptions].map(o=>o.value);
    if(!attendees.length) return alert('S√©lectionne au moins un athl√®te');
    const s = { date, ampm, attendees,
      zone_vert:+$('z_vert').value||0, zone_bleu:+$('z_bleu').value||0, zone_orange:+$('z_orange').value||0, zone_rouge:+$('z_rouge').value||0, zone_violet:+$('z_violet').value||0,
      note: $('z_note').value||null
    };
    const res = await supa.from('sessions').insert(s);
    if (res && res.error) return alert('Erreur: '+res.error.message);
    await syncAll(); renderSessions();
  };
  const tb = $('tblSess');
  tb.innerHTML = (state.sessions||[]).slice(0,20).map(s=>{
    const names = (s.attendees||[]).map(id => (state.athletes.find(a=>a.id===id)||{}).name || '‚Äî').join(', ');
    const total = (+s.zone_vert||0)+(+s.zone_bleu||0)+(+s.zone_orange||0)+(+s.zone_rouge||0)+(+s.zone_violet||0);
    const ampm = s.ampm || '‚Äî';
    return `<tr><td>${s.date}</td><td>${ampm}</td><td>${names}</td><td>${total}</td><td>${s.note||''}</td><td><button class="btn tiny" data-del="${s.id}">Suppr.</button></td></tr>`;
  }).join('');
  tb.querySelectorAll('[data-del]').forEach(b=>{
    b.onclick = async ()=>{
      const res = await supa.from('sessions').delete().eq('id', b.getAttribute('data-del'));
      if (res && res.error) return alert('Erreur: '+res.error.message);
      await syncAll(); renderSessions();
    };
  });
}

// HRV


function renderHRV(){
  if (!isUnlocked()) return renderHome(true);
  const opts = (state.athletes||[]).map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
  elView.innerHTML = `
    <div class="panel">
      <h2>Enregistrer HRV</h2>
      <div class="grid g3" style="margin-top:8px">
        <div><div class="tiny muted">Athl√®te</div><select id="h_ath" class="input">${opts}</select></div>
        <div><div class="tiny muted">Date</div><input id="h_date" class="input" type="date"/></div>
        <div></div>
      </div>

      <div class="grid g3" style="gap:12px; margin-top:10px">
        <div class="panel" style="margin:0">
          <h3 style="margin-bottom:6px">Couch√©</h3>
          <div class="grid g3">
            <div><div class="tiny muted">FC</div><input id="h_fc_c" class="input" type="number" step="0.1"></div>
            <div><div class="tiny muted">RMSSD</div><input id="h_rmssd_c" class="input" type="number" step="0.1"></div>
            <div><div class="tiny muted">HF</div><input id="h_hf_c" class="input" type="number" step="0.1"></div>
            <div><div class="tiny muted">LF</div><input id="h_lf_c" class="input" type="number" step="0.1"></div>
            <div class="g3" style="grid-column:1 / -1"><div class="tiny muted">Commentaire</div><input id="h_comment_c" class="input"></div>
          </div>
          <div class="row" style="justify-content:flex-end;margin-top:8px"><button class="btn primary" id="btnAddHRV_C">Enregistrer Couch√©</button></div>
        </div>
        <div class="panel" style="margin:0">
          <h3 style="margin-bottom:6px">Debout</h3>
          <div class="grid g3">
            <div><div class="tiny muted">FC</div><input id="h_fc_d" class="input" type="number" step="0.1"></div>
            <div><div class="tiny muted">RMSSD</div><input id="h_rmssd_d" class="input" type="number" step="0.1"></div>
            <div><div class="tiny muted">HF</div><input id="h_hf_d" class="input" type="number" step="0.1"></div>
            <div><div class="tiny muted">LF</div><input id="h_lf_d" class="input" type="number" step="0.1"></div>
            <div class="g3" style="grid-column:1 / -1"><div class="tiny muted">Commentaire</div><input id="h_comment_d" class="input"></div>
          </div>
          <div class="row" style="justify-content:flex-end;margin-top:8px"><button class="btn primary" id="btnAddHRV_D">Enregistrer Debout</button></div>
        </div>
      </div>
    </div>

    <div class="panel">
      <h2>R√©sultats (dernier test) ‚Äî Œî vs pr√©c√©dent</h2>
      <div id="hrvResults"></div>
    </div>

    <div class="panel">
      <h2>Historique HRV</h2>
      <table class="table"><thead>
        <tr><th>Date</th><th>Athl√®te</th><th>Posture</th><th>FC</th><th>RMSSD</th><th>HF</th><th>LF</th><th>(LF+HF)/FC</th><th>HF/FC</th><th>LF/FC</th><th>Commentaire</th></tr>
      </thead><tbody id="tblHRV"></tbody></table>
    </div>`;

  function rowsByAth(ath){ return (state.hrv||[]).filter(r=>r.athlete_id===ath).sort((a,b)=> (a.date||'').localeCompare(b.date||'')); }
  function latestByPosture(ath, posture){
    const rows = rowsByAth(ath).filter(r=> (r.posture||'').toLowerCase() === posture.toLowerCase());
    return rows.length ? rows[rows.length-1] : null;
  }
  function prevOf(ath, posture, date){
    const rows = rowsByAth(ath).filter(r=> (r.posture||'').toLowerCase() === posture.toLowerCase() && (r.date||'') < (date||''));
    return rows.length ? rows[rows.length-1] : null;
  }
  function ratio(num, den){ return (num!=null && den) ? (+num)/(+den) : null; }
  function fmt2(v){ return (v==null || Number.isNaN(v)) ? '‚Äî' : (Math.round((+v)*100)/100); }
  function deltaPct(curr, prev){
    if (prev==null || prev===0 || curr==null || isNaN(curr) || isNaN(prev)) return {txt:'‚Äî', cls:'flat'};
    const pct = ((+curr - +prev)/Math.abs(+prev))*100;
    const p = Math.round(pct*10)/10;
    const cls = p>0 ? 'up' : (p<0 ? 'down' : 'flat');
    const arrow = p>0 ? '‚Üë' : (p<0 ? '‚Üì' : '‚Üí');
    return {txt: `${arrow} ${Math.abs(p)} %`, cls};
  }
  function kpiRow(ath, posture){
    const last = latestByPosture(ath, posture);
    if (!last) return `<div class="hrvRow"><div class="hrvHead">${posture==='Couch√©'?'üõè':'üßç'} ${posture}</div><div class="tiny muted">Aucune donn√©e.</div></div>`;
    const prev = prevOf(ath, posture, last.date);
    const fc = last.fc ?? null;
    const rmssd = (last.rmssd != null ? last.rmssd : (last.value != null ? last.value : null));
    const hf = last.hf ?? null;
    const lf = last.lf ?? null;
    const sum_over_fc = ratio((hf!=null?hf:0)+(lf!=null?lf:0), fc);
    const hf_over_fc = ratio(hf, fc);
    const lf_over_fc = ratio(lf, fc);
    const dp_fc = deltaPct(fc, prev? prev.fc:null);
    const dp_rmssd = deltaPct(rmssd, prev? (prev.rmssd!=null?prev.rmssd:prev.value):null);
    const dp_hf = deltaPct(hf, prev? prev.hf:null);
    const dp_lf = deltaPct(lf, prev? prev.lf:null);
    const dp_sum_over_fc = deltaPct(sum_over_fc, prev? ratio((prev.hf!=null?prev.hf:0)+(prev.lf!=null?prev.lf:0), prev.fc):null);
    const dp_hf_over_fc = deltaPct(hf_over_fc, prev? ratio(prev.hf, prev.fc):null);
    const dp_lf_over_fc = deltaPct(lf_over_fc, prev? ratio(prev.lf, prev.fc):null);
    return `
      <div class="hrvRow">
        <div class="hrvHead">${posture==='Couch√©'?'üõè':'üßç'} <span>${posture}</span> <span class="tinyTime">${last.date||''}</span></div>
        <div class="hrvStatWrap">
          <div class="hrvStat"><div class="label">FC moy.</div><div class="value">${fmt2(fc)}</div><div class="delta ${dp_fc.cls}">${dp_fc.txt}</div></div>
          <div class="hrvStat"><div class="label">RMSSD</div><div class="value">${fmt2(rmssd)}</div><div class="delta ${dp_rmssd.cls}">${dp_rmssd.txt}</div></div>
          <div class="hrvStat"><div class="label">LF</div><div class="value">${fmt2(lf)}</div><div class="delta ${dp_lf.cls}">${dp_lf.txt}</div></div>
          <div class="hrvStat"><div class="label">HF</div><div class="value">${fmt2(hf)}</div><div class="delta ${dp_hf.cls}">${dp_hf.txt}</div></div>
          <div class="hrvStat"><div class="label">(LF+HF)/FC</div><div class="value">${fmt2(sum_over_fc)}</div><div class="delta ${dp_sum_over_fc.cls}">${dp_sum_over_fc.txt}</div></div>
          <div class="hrvStat"><div class="label">HF/FC</div><div class="value">${fmt2(hf_over_fc)}</div><div class="delta ${dp_hf_over_fc.cls}">${dp_hf_over_fc.txt}</div></div>
          <div class="hrvStat"><div class="label">LF/FC</div><div class="value">${fmt2(lf_over_fc)}</div><div class="delta ${dp_lf_over_fc.cls}">${dp_lf_over_fc.txt}</div></div>
        </div>
      </div>`;
  }

  function renderKPIs(){
    const ath = document.getElementById('h_ath').value || ((state.athletes[0]||{}).id||null);
    const res = document.getElementById('hrvResults');
    if (res) res.innerHTML = kpiRow(ath, 'Couch√©') + kpiRow(ath, 'Debout');
  }

  // supabase
  async function insertRow(posture){
    const row = {
      athlete_id: document.getElementById('h_ath').value,
      date: document.getElementById('h_date').value || toISO(new Date()),
      posture,
      fc: +document.getElementById(posture==='Couch√©' ? 'h_fc_c' : 'h_fc_d').value || null,
      rmssd: +document.getElementById(posture==='Couch√©' ? 'h_rmssd_c' : 'h_rmssd_d').value || null,
      hf: +document.getElementById(posture==='Couch√©' ? 'h_hf_c' : 'h_hf_d').value || null,
      lf: +document.getElementById(posture==='Couch√©' ? 'h_lf_c' : 'h_lf_d').value || null,
      comment: document.getElementById(posture==='Couch√©' ? 'h_comment_c' : 'h_comment_d').value || null
    };
    const res = await supa.from('hrv').insert(row);
    if (res && res.error) { alert('Erreur: '+res.error.message); return; }
    await syncAll();
    renderHRV();
  }
  document.getElementById('btnAddHRV_C').onclick = ()=> insertRow('Couch√©');
  document.getElementById('btnAddHRV_D').onclick = ()=> insertRow('Debout');
  document.getElementById('h_ath').onchange = renderKPIs;
  renderKPIs();

  // Render table history
  const tb = document.getElementById('tblHRV');
  tb.innerHTML = (state.hrv||[]).slice(0,100).map(r=>{
    const a = state.athletes.find(x=>x.id===r.athlete_id);
    const name = a ? a.name : '‚Äî';
    const fc=r.fc??null, rmssd=(r.rmssd!=null?r.rmssd:(r.value!=null?r.value:null)), hf=r.hf??null, lf=r.lf??null;
    const sum_over_fc = ratio((hf!=null?hf:0)+(lf!=null?lf:0), fc);
    const hf_over_fc = ratio(hf, fc);
    const lf_over_fc = ratio(lf, fc);
    return `<tr>
      <td>${r.date||''}</td><td>${name}</td><td>${r.posture||''}</td>
      <td>${fmt2(fc)}</td><td>${fmt2(rmssd)}</td><td>${fmt2(hf)}</td><td>${fmt2(lf)}</td>
      <td>${fmt2(sum_over_fc)}</td><td>${fmt2(hf_over_fc)}</td><td>${fmt2(lf_over_fc)}</td>
      <td>${r.comment||''}</td>
    </tr>`;
  }).join('');
}

// POIDS
function renderWeight(){
  if (!isUnlocked()) return renderHome(true);
  const opts = (state.athletes||[]).map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
  elView.innerHTML = `
    <div class="panel">
      <h2>Enregistrer Poids</h2>
      <div class="grid g3">
        <div><div class="tiny muted">Athl√®te</div><select id="w_ath" class="input">${opts}</select></div>
        <div><div class="tiny muted">Date</div><input id="w_date" class="input" type="date"/></div>
        <div><div class="tiny muted">Poids</div><input id="w_val" class="input" type="number" step="0.01"/></div>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:8px"><button class="btn primary" id="btnAddW">Enregistrer</button></div>
    </div>
    <div class="panel">
      <h2>Historique Poids</h2>
      <table class="table"><thead><tr><th>Date</th><th>Athl√®te</th><th>Poids</th></tr></thead><tbody id="tblW"></tbody></table>
    </div>`;
  $('btnAddW').onclick = async ()=>{
    const athlete_id = $('w_ath').value; const date = $('w_date').value || toISO(new Date()); const value = +$('w_val').value||0;
    const res = await supa.from('weight').insert({ athlete_id, date, value });
    if (res && res.error) return alert('Erreur: '+res.error.message);
    await syncAll(); renderWeight();
  };
  const tb = $('tblW');
  tb.innerHTML = (state.weight||[]).slice(0,50).map(r=>{
    var a = state.athletes.find(function(x){return x.id===r.athlete_id;});
    return `<tr><td>${r.date}</td><td>${a ? a.name : '‚Äî'}</td><td>${r.value}</td></tr>`;
  }).join('');
}

// COMPETITION
function renderCompetitions(){
  if (!isUnlocked()) return renderHome(true);
  elView.innerHTML = `<div class="panel"><h2>Comp√©titions (prototype)</h2><div class="tiny muted">Module √† faire.</div></div>`;
}

// PLANIF
function renderPlanning(){
  if (!isUnlocked()) return renderHome(true);
  const weeksOpts = listWeeks(50).map(w=>`<option value="${w}" ${w===weekGlobal?'selected':''}>${w}</option>`).join('');
  const seasonsOpts = (state.planning_seasons||[]).map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  const currentWeekRec = (state.planning_weeks||[]).find(function(x){return x.week===weekGlobal;});
  const selSeason = currentWeekRec && currentWeekRec.season_id ? currentWeekRec.season_id : (state.planning_seasons[0] ? state.planning_seasons[0].id : '');

  elView.innerHTML = `
    <div class="panel">
      <h2>Planification ‚Äî Semaine</h2>
      <div class="row" style="gap:12px;flex-wrap:wrap">
        <div class="badge">Semaine <select id="p_week" class="input small" style="width:160px;margin-left:8px">${weeksOpts}</select></div>
        <div class="badge">Saison <select id="p_season" class="input small" style="width:220px;margin-left:8px"><option value="">(Aucune)</option>${seasonsOpts}</select></div>
        <button class="btn tiny" id="pLoad">Charger</button>
      </div>
    </div>
    <div class="panel">
      <h2>Th√®me de la semaine</h2>
      <div class="row" style="gap:10px;align-items:flex-end">
        <input class="input" id="p_theme" placeholder="ex. 'Aff√ªtage ¬∑ focus d√©parts & virages'"/>
        <button class="btn primary" id="pSaveTheme">Enregistrer</button>
      </div>
    </div>
    <div class="panel">
      <h2>Microcycle Structure</h2>
      <div id="p_rows"></div>
      <div class="row" style="margin-top:8px">
        <button class="btn tiny" id="pAddRow">Ajouter une ligne</button>
        <div class="spacer"></div>
        <button class="btn primary" id="pSaveRows">Enregistrer le microcycle</button>
      </div>
    </div>

    <div class="panel">
      <h2>Planification ‚Äî Saison</h2>
      <div class="grid g3">
        <div><div class="tiny muted">Nom de la saison</div><input id="s_name" class="input" placeholder="2025-2026"/></div>
        <div><div class="tiny muted">D√©but</div><input id="s_start" class="input" type="date"/></div>
        <div><div class="tiny muted">Fin</div><input id="s_end" class="input" type="date"/></div>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="s_goal" class="input" placeholder="Objectifs / notes"/>
        <button class="btn primary" id="s_add">Cr√©er saison</button>
      </div>
      <div style="margin-top:12px">
        <h3>Saisons existantes</h3>
        <table class="table"><thead><tr><th>Nom</th><th>P√©riode</th><th>Objectif</th><th></th></tr></thead><tbody id="tblSeasons"></tbody></table>
      </div>
    </div>
  `;

  const pWeekEl = $('p_week'); const pSeasonEl = $('p_season'); pSeasonEl.value = selSeason||'';
  function makeRow(r){
    const wrap = document.createElement('div'); wrap.className = 'planRow';
    wrap.innerHTML = `
      <input class="input" data-k="day_label" value="${r.day_label||''}" placeholder="Jour (ex: D-3)"/>
      <input class="input" data-k="focus" value="${(r.focus||'')}" placeholder="Focus"/>
      <input class="input" data-k="details" value="${(r.details||'')}" placeholder="D√©tails"/>
    `;
    wrap.dataset.sort = r.sort || 0; return wrap;
  }
  function loadAll(){
    const w = pWeekEl.value;
    const rec = (state.planning_weeks||[]).find(function(x){return x.week===w;});
    $('p_theme').value = rec && rec.theme ? rec.theme : '';
    pSeasonEl.value = rec && rec.season_id ? rec.season_id : '';
    const items = (state.planning_items||[]).filter(function(x){return x.week===w;}).sort(function(a,b){ return (a.sort||0)-(b.sort||0); });
    const host = document.getElementById('p_rows'); host.innerHTML = '';
    if (!items.length){
      ['D-5','D-4','D-3','D-2','D-1','D0'].forEach(function(lab,i){ host.appendChild(makeRow({day_label:lab, focus:'', details:'', sort:i+1})); });
    } else { items.forEach(function(it){ host.appendChild(makeRow(it)); }); }
  }
  $('pLoad').onclick = loadAll; pWeekEl.onchange = loadAll; loadAll();

  $('pSaveTheme').onclick = async ()=>{
    const w = pWeekEl.value; const theme = $('p_theme').value.trim(); const season_id = $('p_season').value || null;
    const res = await supa.from('planning_weeks').upsert({ week:w, theme, season_id }, { onConflict:'week' });
    if (res && res.error) return alert('Erreur: '+res.error.message);
    await syncAll(); alert('Th√®me enregistr√©');
  };
  $('pAddRow').onclick = ()=>{
    const host = document.getElementById('p_rows'); const n = host.children.length;
    host.appendChild(makeRow({day_label:'', focus:'', details:'', sort:n+1}));
  };
  $('pSaveRows').onclick = async ()=>{
    const w = pWeekEl.value; const host = document.getElementById('p_rows');
    const rows = [...host.children].map((div,i)=>{
      const map = {}; div.querySelectorAll('input').forEach(inp=> map[inp.dataset.k]=inp.value);
      return { week:w, day_label:map.day_label||'', focus:map.focus||'', details:map.details||'', sort:i+1 };
    }).filter(x=> x.day_label || x.focus || x.details);
    const del = await supa.from('planning_items').delete().eq('week', w);
    if (del && del.error) return alert('Erreur (delete): ' + del.error.message);
    if (rows.length){
      const ins = await supa.from('planning_items').insert(rows);
      if (ins && ins.error) return alert('Erreur (insert): ' + ins.error.message);
    }
    await syncAll(); alert('Microcycle enregistr√©');
  };

  // Seasons CRUD
  const tbl = $('tblSeasons');
  tbl.innerHTML = (state.planning_seasons||[]).map(s=>`<tr><td>${s.name||''}</td><td>${s.start_date||''} ‚Üí ${s.end_date||''}</td><td>${s.goal||''}</td><td><button class="btn tiny" data-del="${s.id}">Suppr.</button></td></tr>`).join('');
  tbl.querySelectorAll('[data-del]').forEach(b=>{
    b.onclick = async ()=>{ const res = await supa.from('planning_seasons').delete().eq('id', b.getAttribute('data-del')); if (res && res.error) return alert('Erreur: '+res.error.message); await syncAll(); renderPlanning(); };
  });
  $('s_add').onclick = async ()=>{
    const name=$('s_name').value.trim(); if(!name) return alert('Nom requis');
    const start_date=$('s_start').value||null; const end_date=$('s_end').value||null; const goal=$('s_goal').value||null;
    const res = await supa.from('planning_seasons').insert({ name, start_date, end_date, goal });
    if (res && res.error) return alert('Erreur: '+res.error.message);
    await syncAll(); renderPlanning();
  };
}

// BOOT
window.addEventListener('load', async () => {
  try{ await syncAll(); }catch(e){ console.warn('sync error', e); }
  const tabs = document.querySelectorAll('.tab');
  if (tabs[0]) { tabs[0].classList.add('active'); }
  mountTabs();
});

</script>
</body>
</html>

<script>
function renderTesting(){
  if (!isUnlocked()) return renderHome(true);
  const opts = (state.athletes||[]).map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
  elView.innerHTML = `
    <div class="panel">
      <h2>Tests ‚Äî Vitesse critique (CSS)</h2>
      <div class="grid g3" style="margin-top:8px">
        <div><div class="tiny muted">Athl√®te</div><select id="t_ath" class="input">${opts}</select></div>
        <div><div class="tiny muted">Date</div><input id="t_date" type="date" class="input"/></div>
        <div></div>
      </div>
      <div class="grid g3" style="margin-top:8px">
        <div><div class="tiny muted">Temps 200m (mm:ss)</div><input id="t_200" class="input" placeholder="ex: 02:20"></div>
        <div><div class="tiny muted">Temps 400m (mm:ss)</div><input id="t_400" class="input" placeholder="ex: 05:00"></div>
        <div class="row" style="align-items:flex-end"><button id="btnCalc" class="btn">Calculer</button><button id="btnSave" class="btn primary" style="margin-left:8px">Enregistrer</button></div>
      </div>
      <div class="kpisLine" id="t_kpis" style="margin-top:10px"></div>
    </div>
    <div class="panel">
      <h2>Historique des tests (CSS)</h2>
      <table class="table"><thead>
        <tr><th>Date</th><th>Athl√®te</th><th>t200</th><th>t400</th><th>CSS (m/s)</th><th>Allure (100m)</th></tr>
      </thead><tbody id="t_tbl"></tbody></table>
    </div>`;
  function toSec(v){ if (!v) return null; if (typeof v==='number') return v; const p=String(v).split(':'); if(p.length===2) return (+p[0])*60+(+p[1]); if(p.length===3) return (+p[0])*3600+(+p[1])*60+(+p[2]); const n=+v; return isNaN(n)? null:n; }
  function fmt(x){ return (x==null||isNaN(x))? '‚Äî' : (Math.round(x*100)/100); }
  function pace100(sec){ if (sec==null||isNaN(sec)) return '‚Äî'; const m=Math.floor(sec/60); const s=Math.round(sec%60).toString().padStart(2,'0'); return m+':'+s; }
  function computeCSS(t200, t400){ if(!t200||!t400|| (t400-t200)<=0) return null; return 200/(t400-t200); }

  function renderHistory(){
    const ath = document.getElementById('t_ath').value || selectedAthleteId;
    const rows = (state.tests||[]).filter(r=> r.type==='CSS' && r.athlete_id===ath).sort((a,b)=> (b.date||'').localeCompare(a.date||''));
    const tb = document.getElementById('t_tbl');
    tb.innerHTML = rows.map(r=>{
      const t200=toSec(r.t200), t400=toSec(r.t400);
      const cv=computeCSS(t200,t400), p=(t400-t200)/2;
      const aobj=state.athletes.find(x=>x.id===r.athlete_id);
      return `<tr><td>${r.date||''}</td><td>${aobj?aobj.name:'‚Äî'}</td><td>${r.t200||''}</td><td>${r.t400||''}</td><td>${fmt(cv)}</td><td>${pace100(p)}</td></tr>`;
    }).join('');
  }

  function renderKPIs(){
    const ath = document.getElementById('t_ath').value || selectedAthleteId;
    const rows = (state.tests||[]).filter(r=> r.type==='CSS' && r.athlete_id===ath).sort((a,b)=> (a.date||'').localeCompare(b.date||''));
    const box = document.getElementById('t_kpis');
    if (!rows.length){ box.innerHTML='<div class="tiny muted">Aucun test.</div>'; return; }
    const last=rows[rows.length-1], prev=rows.length>1?rows[rows.length-2]:null;
    const t200=toSec(last.t200), t400=toSec(last.t400);
    if(!t200||!t400|| (t400-t200)<=0){ box.innerHTML='<div class="tiny muted">Donn√©es invalides.</div>'; return; }
    const cv=computeCSS(t200,t400), p=(t400-t200)/2;
    let prevCv=null; if(prev){ const t200p=toSec(prev.t200), t400p=toSec(prev.t400); if(t200p&&t400p&&(t400p-t200p)>0) prevCv=computeCSS(t200p,t400p); }
    const delta = (!prevCv||!cv)? {txt:'‚Äî',cls:'flat'} : (()=>{ const pct=(cv-prevCv)/Math.abs(prevCv)*100; const r=Math.round(pct*10)/10; const cls=r>0?'up':(r<0?'down':'flat'); const arrow=r>0?'‚Üë':(r<0?'‚Üì':'‚Üí'); return {txt:`${arrow} ${Math.abs(r)} %`, cls}; })();
    box.innerHTML = `
      <div class="kpiChip"><div class="label">CSS (m/s)</div><div class="value">${fmt(cv)}</div><div class="delta ${delta.cls}">${delta.txt}</div></div>
      <div class="kpiChip"><div class="label">CSS (km/h)</div><div class="value">${fmt(cv*3.6)}</div></div>
      <div class="kpiChip"><div class="label">Allure 100m</div><div class="value">${pace100(p)}</div></div>`;
  }

  document.getElementById('btnCalc').onclick = renderKPIs;
  document.getElementById('t_ath').onchange = ()=>{ renderKPIs(); renderHistory(); };

  document.getElementById('btnSave').onclick = async ()=>{
    const row = {
      type:'CSS',
      athlete_id: document.getElementById('t_ath').value || selectedAthleteId,
      date: document.getElementById('t_date').value || toISO(new Date()),
      t200: document.getElementById('t_200').value,
      t400: document.getElementById('t_400').value
    };
    let ok=false;
    if (supa){
      try{
        const res = await supa.from('tests').insert(row);
        if (res && res.error){ alert('Erreur: '+res.error.message); }
        else ok=true;
      }catch(e){}
    }
    if (!ok){
      state.tests = state.tests || [];
      state.tests.push(row);
      try{ localStorage.setItem('cnm_tests', JSON.stringify(state.tests)); }catch(e){}
    }
    await refreshTests().catch(()=>{});
    renderTesting();
  };

  try{
    if (!state.tests || !state.tests.length){
      const raw = localStorage.getItem('cnm_tests'); if (raw) state.tests = JSON.parse(raw);
    }
  }catch(e){}
  const sel = document.getElementById('t_ath'); if (selectedAthleteId && sel) sel.value = selectedAthleteId;
  renderKPIs(); renderHistory();
}
</script>
